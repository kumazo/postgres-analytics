--
-- ntile関数による標本分割
--


-- 100万行のテーブル
drop table if exists data01;
create table data01(
    id serial primary key, 
    val NUMERIC
); 
insert into data01 select i, random() from generate_series(1, 1000000) as gs(i);

-- 処理時間計測
\timing


-- 10万分割して10個ずつ
with
ntile as (
  select id, ntile(100000) over(order by id) as p from data01
)
select data01.* from ntile inner join data01 using(id) where p % 10 = 1 
;

/*
   id   |          val           
--------+------------------------
      1 |     0.0288370288908482
      2 |       0.73235490731895
      3 |      0.663330631796271
      4 |      0.257534547243267
      5 |      0.886185809969902
      6 |      0.916080312337726
      7 |     0.0788819212466478
      8 |      0.721183981280774
      9 |      0.470417462754995
     10 |       0.98419364541769
    101 |     0.0892221173271537
    102 |      0.740029320120811
    103 |      0.599694530013949
    104 |      0.534306542947888
    105 |      0.567264967598021
    106 |      0.518338576424867
    107 |      0.708059544209391
    108 |      0.481091244146228
    109 |      0.131800954695791
    110 |      0.646993697155267
    201 |      0.858862433582544
    202 |      0.821597145870328
    203 |      0.663761231582612
    204 |       0.29002471268177
    205 |     0.0027655535377562
    206 |      0.431173836346716
    207 |      0.366149662528187
    208 |     0.0690460414625704
    209 |      0.535881466697901
    210 |      0.398380261380225
    301 |      0.768133779987693
    302 |      0.537183060776442
    303 |      0.614273357670754
    :
*/



-- 10000分割して100個ずつ
with
ntile as (
  select id, ntile(10000) over(order by id) as p from data01
)
select data01.* from ntile inner join data01 using(id) where p % 10 = 1 
;
/*
   id   |           val           
--------+-------------------------
      1 |      0.0288370288908482
      2 |        0.73235490731895
      3 |       0.663330631796271
      4 |       0.257534547243267
      5 |       0.886185809969902
      6 |       0.916080312337726
      7 |      0.0788819212466478
      8 |       0.721183981280774
      9 |       0.470417462754995
     10 |        0.98419364541769
     11 |       0.352810143493116
     12 |       0.208164605312049
     13 |       0.410726117901504
     14 |       0.129535041283816
     15 |       0.445904029067606
      :
     88 |       0.978807660285383
     89 |       0.133621141314507
     90 |        0.26163239357993
     91 |       0.748589930124581
     92 |       0.569155633449554
     93 |     0.00753069669008255
     94 |       0.218965082895011
     95 |       0.643643725197762
     96 |       0.799453218467534
     97 |       0.647467665374279
     98 |       0.243271226063371
     99 |       0.553480272181332
    100 |       0.112979599274695
   1001 |       0.231771300081164
   1002 |       0.888963329605758
   1003 |       0.492782859597355
   1004 |       0.683346315287054
   1005 |       0.661591181531549
   1006 |      0.0760481408797204
   1007 |       0.653360650874674
   1008 |       0.751714957877994
   1009 |       0.454848282970488
   1010 |       0.832158312667161
   1011 |       0.604743746574968
   1012 |       0.911841549444944
   1013 |       0.999723544344306
   1014 |       0.272775568068027
   1015 |        0.17586025595665
   1016 |       0.646940743550658
   1017 |       0.209091880824417
   1018 |       0.866102086845785
   1019 |       0.635490500368178
   1020 |       0.781777312513441
      :
   1089 |      0.0159153351560235
   1090 |       0.647549177054316
   1091 |       0.677640174515545
   1092 |       0.915980766527355
   1093 |       0.920355468988419
   1094 |      0.0516383564099669
   1095 |       0.235313937067986
   1096 |       0.521972650662065
   1097 |        0.62404944607988
   1098 |       0.635506029240787
   1099 |       0.528448862954974
   1100 |      0.0482340943999588
   2001 |       0.917287656106055
   2002 |       0.646492931991816
   2003 |       0.892558045685291
   2004 |        0.63003116613254
   2005 |       0.574572472833097
   2006 |        0.93036819761619
   2007 |       0.577453295700252
   2008 |        0.22956512356177
   2009 |       0.347495774272829
   2010 |      0.0608551949262619
   2011 |       0.422142433002591
   2012 |       0.639420025516301
   2013 |       0.457033804152161
   2014 |        0.77431890880689
   2015 |       0.634487904142588
   2016 |       0.764023325406015
   2017 |       0.205973660107702
   2018 |      0.0197925255633891
*/

-- 1000分割して1000個ずつ
with
ntile as (
  select id, ntile(1000) over(order by id) as p from data01
)
select data01.* from ntile inner join data01 using(id) where p % 10 = 1 
;
/*
   id   |           val           
--------+-------------------------
      1 |      0.0288370288908482
      2 |        0.73235490731895
      3 |       0.663330631796271
      4 |       0.257534547243267
      5 |       0.886185809969902
      6 |       0.916080312337726
      7 |      0.0788819212466478
      8 |       0.721183981280774
      9 |       0.470417462754995
     10 |        0.98419364541769
     11 |       0.352810143493116
     12 |       0.208164605312049
     13 |       0.410726117901504
     14 |       0.129535041283816
     15 |       0.445904029067606
     16 |       0.262889217119664
     17 |      0.0365125765092671
     18 |       0.711010032333434
     19 |        0.88197952369228
     20 |       0.937439584638923
     21 |     0.00491185579448938
     22 |       0.347957779187709
     :
    987 |     0.690241830889136
    988 |      0.98854975681752
    989 |     0.572685431689024
    990 |      0.43456445587799
    991 |     0.652991023845971
    992 |     0.760008334647864
    993 |     0.718479555565864
    994 |      0.32469826657325
    995 |     0.791102616116405
    996 |     0.217291073873639
    997 |     0.955850495491177
    998 |     0.950407028663903
    999 |     0.293867237400264
   1000 |      0.26699774293229
  10001 |     0.518245226703584
  10002 |    0.0328651946038008
  10003 |     0.741208661813289
  10004 |     0.832657299935818
  10005 |     0.988339782226831
  10006 |     0.869082147721201
  10007 |     0.865757077932358
  10008 |     0.612705200910568
  10009 |     0.610399552155286
  10010 |     0.968245401978493
  10011 |     0.551672114059329
  10012 |     0.863105484750122
  10013 |     0.207742371596396
  10014 |     0.834014801774174
  10015 |     0.956654467154294
  10016 |   0.00901998346671462
  10017 |     0.739834046456963
  10018 |      0.74555863533169
  10019 |     0.479446020908654
  10020 |    0.0603634584695101
  10021 |      0.42891142051667
*/
-- 後始末
drop table if exists data01;

