--
-- ボックス・ミュラー法(Box-Muller's method)による正規乱数の生成
--

--
-- ボックス・ミュラー法による正規乱数を返す関数
-- μ 期待値
-- σ 標準偏差
--
create or replace function random_box_muller(μ double precision, σ double precision)
returns double precision
as $$
  with ur(X, Y) as (select random(), random())
  select
    -- 万一、ln(0.0)に当たるとエラーになるが、行ないが善いので気にしない
    sqrt(-2 * ln(X)) * cos(2 * pi() * Y) * σ + μ
  from ur;
$$ language sql;

-- 試行
select random_box_muller(μ := 0, σ := 1)
;
/*
 random_box_muller 
-------------------
  1.02979384147207
(1 row)
*/

-- 検証
with
norm as (
  select n, random_box_muller(0, 1) as nd from generate_series(1,10000) as gs(n)
)
select n, nd as smpl, 
  avg(nd) over(order by n) as mean, 
  var_pop(nd) over (order by n) as variance
from norm 
;
/*
   n   |         smpl          |         mean          |       variance       
-------+-----------------------+-----------------------+----------------------
     1 |     0.552920660118492 |     0.552920660118492 |                    0
     2 |     0.588972933156604 |     0.570946796637548 | 0.000324941597803663
     3 |    -0.337421111020928 |     0.268157494084723 |    0.183579351212722
     4 |     -1.77111812538051 |    -0.241661410781586 |    0.917430460686787
     5 |   -0.0846670825107549 |     -0.21026254512742 |    0.737887923606903
     6 |     0.716522217661286 |   -0.0557984179959686 |    0.734202435858158
     7 |    -0.622381384862159 |    -0.136738841833996 |    0.668624486859184
     8 |    -0.329515428453231 |      -0.1608359151614 |     0.58911110860241
     9 |    -0.319085880418749 |    -0.178419244634439 |    0.526127706560557
    10 |     0.686403449958153 |   -0.0919369751751798 |    0.540827582281917
    11 |    -0.441592514689944 |    -0.123723842403795 |    0.501765487720202
    12 |     -0.51222318235675 |    -0.156098787399874 |    0.471481204775343
    13 |      1.63367830287274 |   -0.0184236266096733 |    0.662666818575917
    14 |    -0.156885917111253 |    -0.028313790216929 |     0.61660507376224
    15 |      -2.5196639256536 |    -0.194403799246041 |    0.961700544234823
    16 |      1.69529518355118 |   -0.0762976128212144 |     1.11083032929738
    17 |    -0.676615393814455 |    -0.111610423467876 |     1.06543928228275
    18 |    -0.238289575516935 |    -0.118648154137268 |     1.00709021514539
    19 |     0.273070069588135 |   -0.0980314055201413 |    0.961736372803598
    20 |   -0.0571063036242355 |   -0.0959851504253461 |    0.913729110201765
    21 |     0.396773230432535 |   -0.0725204656225898 |    0.881230028850011
    22 |    -0.111408888013004 |   -0.0742881211857905 |     0.84123973517773
    23 |     -1.78019948385647 |    -0.148458180432342 |    0.925690443667841
    24 |    -0.611988854137023 |     -0.16777195850337 |    0.895699515052684
    25 |     0.929889886320538 |    -0.123865484710414 |    0.906138217032934
     :
  9990 |     0.421949942470995 |  -0.00278807409337113 |  1.00156546738541
  9991 |      3.22641190654473 |  -0.00246486320550824 |  1.00250882874413
  9992 |     0.395000340636573 |  -0.00242508486244958 |  1.00242430652125
  9993 |      0.49673141069301 |  -0.00237513424746355 |  1.00234892455061
  9994 |    0.0758405892445648 |  -0.00236730797935348 |  1.00224924155709
  9995 |    -0.323259469460336 |  -0.00239941324813597 |  1.00215926779374
  9996 |    -0.142506637240423 |  -0.00241342957706677 |  1.00206097535703
  9997 |     -1.66000137145998 |  -0.00257923811381608 |  1.00223555392735
  9998 |     -1.14810194044702 |  -0.00269381329908646 |  1.00226654567162
  9999 |      2.11195692985942 |  -0.00248232707614831 |  1.00261348376546
 10000 |      1.32936374945627 |  -0.00234914246849507 |  1.00269058607611
(10000 rows)
*/

-- ヒストグラム
with
norm as (
  select n, random_box_muller(0, 1) as nd from generate_series(1,10000) as gs(n)
),
hist as (
  select floor(nd*10)/10 as bin, count(nd) as cnt
  from norm group by bin order by bin
)
select bin,
  cnt::double precision / sum(cnt) over() as density,
  repeat('*',((cnt/sum(cnt) over())*1000)::int) as bar
from hist
;
/*
bin  | density |                     bar                     
------+---------+---------------------------------------------
 -4.5 |  0.0001 | 
   -4 |  0.0001 | 
 -3.7 |  0.0001 | 
 -3.6 |  0.0001 | 
 -3.5 |  0.0002 | 
 -3.4 |  0.0001 | 
 -3.3 |  0.0007 | *
 -3.2 |  0.0003 | 
 -3.1 |  0.0006 | *
   -3 |  0.0004 | 
 -2.9 |  0.0012 | *
 -2.8 |  0.0007 | *
 -2.7 |  0.0008 | *
 -2.6 |  0.0016 | **
 -2.5 |  0.0026 | ***
 -2.4 |  0.0024 | **
 -2.3 |  0.0027 | ***
 -2.2 |  0.0039 | ****
 -2.1 |  0.0054 | *****
   -2 |   0.007 | *******
 -1.9 |  0.0061 | ******
 -1.8 |  0.0075 | ********
 -1.7 |  0.0109 | ***********
 -1.6 |  0.0129 | *************
 -1.5 |  0.0142 | **************
 -1.4 |  0.0161 | ****************
 -1.3 |  0.0166 | *****************
 -1.2 |  0.0202 | ********************
 -1.1 |  0.0241 | ************************
   -1 |  0.0263 | **************************
 -0.9 |  0.0254 | *************************
 -0.8 |  0.0313 | *******************************
 -0.7 |  0.0291 | *****************************
 -0.6 |  0.0322 | ********************************
 -0.5 |  0.0413 | *****************************************
 -0.4 |  0.0369 | *************************************
 -0.3 |  0.0429 | *******************************************
 -0.2 |  0.0407 | *****************************************
 -0.1 |  0.0371 | *************************************
    0 |   0.042 | ******************************************
  0.1 |   0.041 | *****************************************
  0.2 |  0.0382 | **************************************
  0.3 |  0.0327 | *********************************
  0.4 |  0.0347 | ***********************************
  0.5 |  0.0326 | *********************************
  0.6 |  0.0351 | ***********************************
  0.7 |  0.0286 | *****************************
  0.8 |  0.0323 | ********************************
  0.9 |  0.0243 | ************************
    1 |  0.0199 | ********************
  1.1 |  0.0194 | *******************
  1.2 |  0.0193 | *******************
  1.3 |  0.0172 | *****************
  1.4 |  0.0131 | *************
  1.5 |  0.0114 | ***********
  1.6 |  0.0092 | *********
  1.7 |  0.0097 | **********
  1.8 |   0.008 | ********
  1.9 |  0.0068 | *******
    2 |  0.0044 | ****
  2.1 |  0.0036 | ****
  2.2 |  0.0027 | ***
  2.3 |  0.0021 | **
  2.4 |  0.0028 | ***
  2.5 |  0.0009 | *
  2.6 |  0.0013 | *
  2.7 |   0.001 | *
  2.8 |  0.0005 | *
  2.9 |  0.0006 | *
    3 |  0.0007 | *
  3.1 |  0.0001 | 
  3.2 |  0.0002 | 
  3.3 |  0.0006 | *
  3.6 |  0.0001 | 
  4.5 |  0.0001 | 
(75 rows)
*/

-- 後始末
drop function if exists norm_bm;

